# Simulation

Our paper utilizes both real-world hardware for baseline benchmarking as well as simulated at-bank RISC-V cores. We run instrumented benchmarks on the real world hardware to gather region relative-timing data, as well as evaluate the duration of region offload (using the scripts found in the [relayout](https://github.com/dovedevic/blimp/tree/main/relayout) folder). With these timings and baselines, we run the same applications, where applicable, in the RISC-V OVP Simulator and trace instructions and memory accesses (as described below) and extrapolate BLIMP region relative-timing data for baseline comparison. 

# riscvOVPsim

The Imperas RISC-V OVP Simulator is a RISC-V compliance simulator. Because **it is not a cycle accurate simulator**, we augment it's output assuming a simple CPU architecture (single stage, in order) to pull meaningful data from the simulation output. Of course we use the simulator to ensure kernels and benchmarks produce correct outputs, but also we use instruction histograms and memory traces to estimate at-bank runtimes. 

The provided GitHub repository contains the base simulator. If you plan to simulate vector extension instructions (v0.9+ RISCV-V ISA), you have to use the `riscvOVPsimPlus` version of the simulator (which can be found on the [ovpsim](https://www.ovpworld.org/library/wikka.php?wakka=riscvOVPsimPlus) website). 

After installing the simulator and ensuring your license is valid, proceed to compiling benchmarks to ELF format.

To run a BLIMP/-V bank ELF benchmark (which includes chronometry), we use the following simulator command:

```sh
/path/to/riscv-ovpsim/bin/Linux64/riscvOVPsim.exe  \
    --variant RV64GCV \
    --override riscvOVPsim/cpu/mips=2.000000e+02 \
    --override riscvOVPsim/cpu/mstatus_FS=1 \
    --override riscvOVPsim/cpu/vector_version=0.9 \
    --override riscvOVPsim/cpu/VLEN=8192 \
    --trace \
    --tracemem SA \
    --program {benchmark}.elf \
    --argv {args, ...} \
| tee {benchmark}.trace && cat chrono_result.out >> {benchmark}.trace
```

This command will run `{benchmark}.elf` on a `RV64GCV` architecture processor running at 200MHz with a 1KB row buffer with vector ISA v0.9. The output of the simulation is simulator logs, instruction traces, memory traces, and the chronometry output in a file called `{benchmark}.trace`.

This trace file is processed by the files in the accompanying scripts folder herein.


# DRAMsim2

DRAM Sim 2 is a cycle-accurate DRAM architecture simulator. Using the system configurations defined by Table 1 of the paper, we use memory traces generated by riscvOVPsim to generate accurate bank/memory latency timing data.

# Evaluating Benchmark Runtimes

After riscvOVPsim finishes simulation of a provided benchmark, we feed its trace output into the scripts provided. Instruction histograms that are generated are used to calculate approximate runtimes by multiplying opcode occurrences with it's BLIMP-cycle timing IPC. Memory traces are directly forwarded to DRAMsim2. The final runtime is the addition of these two metrics, then scaled based on the chronometry of the region in question that is studied.
